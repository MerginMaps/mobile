name: Android
on:
  push:
    paths:
    - 'app/**'
    - 'core/**'
    - 'scripts/**'
    - 'cmake/**'
    - 'cmake_templates/**'
    - 'CMakeLists.txt'
    - '.github/workflows/android.yml'

  release:
    types:
      - published

concurrency:
  group: ci-${{github.ref}}-android
  cancel-in-progress: true

jobs:
  android_build:
    if: ( github.repository == 'MerginMaps/mobile' ) && (!contains(github.event.head_commit.message, 'Translate '))
    runs-on: macos-15
    env:
      QT_VERSION: '6.8.3' # use scripts/update_qt_version.bash to change
      NDK_VERSION: 'r26' # '26.1.10909125'
      NDK_VERSION_FULL: r26b
      JDK_VERSION: 17
      SDK_PLATFORM: android-34
      SDK_BUILD_TOOLS: 34.0.0
      INPUT_SDK_VERSION_ARM: arm-android-20250326-241
      INPUT_SDK_VERSION_ARM64: arm64-android-20250326-241
      CCACHE_DIR: /Users/runner/work/ccache
      GITHUB_TOKEN: ${{ secrets.INPUTAPP_BOT_GITHUB_TOKEN }}
      CACHE_VERSION: 0
      CMAKE_VERSION: '3.29.0'
      QT_ANDROID_KEYSTORE_ALIAS: input
      QT_ANDROID_KEYSTORE_KEY_PASS: ${{ secrets.INPUTKEYSTORE_STOREPASS }}
      QT_ANDROID_KEYSTORE_STORE_PASS: ${{ secrets.INPUTKEYSTORE_STOREPASS }}
      XC_VERSION: ${{ '16.2' }}

    steps:
      - uses: actions/checkout@v4

      - name: Disk space before cleanup
        run: |
          df -h .

      #
      # Simulators on macOS runners take up a lot of disk space.
      # We do not use them and are in need of some additional disk space.
      #
      # See https://github.com/actions/runner-images/issues/10511 and
      # https://github.com/carbon-language/carbon-lang/pull/4287
      #
      - name: Delete simulators to reclaim disk space
        shell: bash
        run: |
          find /Applications/Xcode* -name "*.app" -exec du -mcsh {} \;  # Shows Xcode app sizes
          find /Applications/Xcode_* -maxdepth 0 -type d ! -name 'Xcode_16.2.app' -exec rm -rf {} \;
          echo "---- cleaned!"
          find /Applications/Xcode* -name "*.app" -exec du -mcsh {} \;  # Shows Xcode app sizes

      - name: Disk space after cleanup
        run: |
          df -h .
